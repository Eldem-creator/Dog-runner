<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dog Runner ‚Äî Classement Mondial</title>
<style>
:root {
  --bg: #87ceeb;
  --ground: #cce0aa;
  --primary: #2b8bf2;
  --text: #222;
  --card-bg: #fff;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: 'Poppins', sans-serif;
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
}

canvas {
  background: linear-gradient(var(--bg), var(--ground));
  display: block;
  margin-top: 10px;
  border: 3px solid var(--primary);
  border-radius: 12px;
}

#ui {
  margin-top: 10px;
  text-align: center;
}

button {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  margin: 4px;
  cursor: pointer;
  font-weight: bold;
}

button:hover {
  opacity: 0.85;
}

#leaderboard {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  margin-top: 15px;
  padding: 10px;
  width: 300px;
}

#leaderboard h3 {
  margin: 6px 0;
  text-align: center;
  color: var(--primary);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 4px;
  border-bottom: 1px solid #ccc;
  text-align: center;
}

tr:nth-child(1) { background: #ffd70044; }
tr:nth-child(2) { background: #c0c0c044; }
tr:nth-child(3) { background: #cd7f3244; }
</style>
</head>
<body>
<h1>üêæ Dog Runner ‚Äî Classement Mondial üí∞</h1>

<canvas id="game" width="600" height="250"></canvas>

<div id="ui">
  <p id="player-info"></p>
  <button id="start">‚ñ∂Ô∏è Jouer</button>
  <button id="logout">üö™ D√©connexion</button>
</div>

<div id="leaderboard">
  <h3>üèÜ Classement Mondial (bas√© sur les Coins)</h3>
  <table id="leaderboard-table">
    <thead><tr><th>Rang</th><th>Pseudo</th><th>Coins</th><th>Score Max</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const groundY = canvas.height - 40;

let player, obstacles, coins, score, coinsCollected, isPlaying;
let speed = 4;

// ==== AUTH / JOUEUR ====
let currentPlayer = JSON.parse(localStorage.getItem("currentPlayer") || "null");
let leaderboard = JSON.parse(localStorage.getItem("leaderboard") || "[]");

function saveLeaderboard() {
  localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
}

function updateLeaderboardDisplay() {
  const tbody = document.querySelector("#leaderboard-table tbody");
  leaderboard.sort((a,b)=>b.coins - a.coins);
  tbody.innerHTML = leaderboard.map((p,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${p.name}</td>
      <td>${p.coins}</td>
      <td>${p.bestScore}</td>
    </tr>
  `).join('');
}

function promptLogin() {
  let name = prompt("Entre ton pseudo :").trim();
  if (!name) return promptLogin();
  currentPlayer = leaderboard.find(p => p.name === name);
  if (!currentPlayer) {
    currentPlayer = { name, coins: 0, bestScore: 0 };
    leaderboard.push(currentPlayer);
    saveLeaderboard();
  }
  localStorage.setItem("currentPlayer", JSON.stringify(currentPlayer));
  document.getElementById("player-info").textContent = `Connect√© en tant que : ${name}`;
  updateLeaderboardDisplay();
}

function logout() {
  localStorage.removeItem("currentPlayer");
  document.getElementById("player-info").textContent = "D√©connect√©.";
  currentPlayer = null;
  promptLogin();
}

// ==== JEU ====
function resetGame() {
  player = { x: 50, y: groundY, w: 30, h: 30, vy: 0, jumping: false };
  obstacles = [];
  coins = [];
  score = 0;
  coinsCollected = 0;
  isPlaying = true;
}

function jump() {
  if (!player.jumping) {
    player.vy = -9;
    player.jumping = true;
  }
}

function crouch(e) {
  if (e.key === "ArrowDown") player.h = 15;
}
function stand(e) {
  if (e.key === "ArrowDown") player.h = 30;
}

document.addEventListener("keydown", e=>{
  if (e.code==="Space" || e.code==="ArrowUp") jump();
  if (e.key==="ArrowDown") crouch(e);
});
document.addEventListener("keyup", stand);

function update() {
  if (!isPlaying) return;

  player.vy += 0.5;
  player.y += player.vy;
  if (player.y >= groundY) {
    player.y = groundY;
    player.vy = 0;
    player.jumping = false;
  }

  if (Math.random() < 0.02) obstacles.push({ x: canvas.width, y: groundY, w: 20, h: 30 });
  if (Math.random() < 0.015) coins.push({ x: canvas.width, y: groundY - 50, r: 8 });

  obstacles.forEach(o => o.x -= speed);
  coins.forEach(c => c.x -= speed);

  // collisions
  for (let o of obstacles) {
    if (player.x < o.x + o.w && player.x + player.w > o.x &&
        player.y < o.y + o.h && player.y + player.h > o.y) {
      gameOver();
      return;
    }
  }

  coins = coins.filter(c=>{
    if (Math.abs(player.x - c.x) < 20 && Math.abs(player.y - c.y) < 20) {
      coinsCollected++;
      return false;
    }
    return c.x > -10;
  });

  score++;
  draw();
  requestAnimationFrame(update);
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ground');
  ctx.fillRect(0,groundY+30,canvas.width,20);
  ctx.fillStyle = "brown";
  obstacles.forEach(o=>ctx.fillRect(o.x,o.y,o.w,o.h));
  ctx.fillStyle = "gold";
  coins.forEach(c=>{
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
    ctx.fill();
  });
  ctx.fillStyle = "green";
  ctx.fillRect(player.x, player.y - player.h, player.w, player.h);
  ctx.fillStyle = "#000";
  ctx.fillText(`Score: ${score}`, 10, 20);
  ctx.fillText(`Coins: ${coinsCollected}`, 10, 40);
}

function gameOver() {
  isPlaying = false;
  alert("üí• Game Over !");
  // mise √† jour des donn√©es
  currentPlayer.coins += coinsCollected;
  currentPlayer.bestScore = Math.max(currentPlayer.bestScore, score);
  const idx = leaderboard.findIndex(p=>p.name===currentPlayer.name);
  if (idx >= 0) leaderboard[idx] = currentPlayer;
  saveLeaderboard();
  updateLeaderboardDisplay();
}

// ==== INIT ====
document.getElementById("start").onclick = ()=>{
  if (!currentPlayer) promptLogin();
  resetGame();
  update();
};
document.getElementById("logout").onclick = logout;

if (!currentPlayer) promptLogin();
else document.getElementById("player-info").textContent = `Connect√© en tant que : ${currentPlayer.name}`;

updateLeaderboardDisplay();
</script>
</body>
</html>
